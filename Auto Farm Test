_G.auto = true

-- üì¶ D·ªãch v·ª• Roblox
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")

-- üßç Ng∆∞·ªùi ch∆°i
local player = Players.LocalPlayer
local mouse = player:GetMouse()
local gui = player:WaitForChild("PlayerGui")

-- ‚öôÔ∏è Bi·∫øn tr·∫°ng th√°i
local _isInGame = false
local currentFruit = nil
local currentHumanoid = nil
local staminaBar = nil
local THRESHOLD = 0.0000000000000000000000001 -- Mana d∆∞·ªõi 10% th√¨ reset

-- üí• Danh s√°ch k·ªπ nƒÉng
local skills = {
    DoughV2 = {"GrilledLance", "ElasticLasso", "Oblivion", "PowerDough", "BlazingStorm", "ScorchingBuzzcut"},
    Ope = {"Room", "Takt", "Wreckage", "HurricaneShock", "GammaKnife", "Mes", "Shambles"},
    LeopardV2 = {"FingerPistolBarrage", "SonicKick", "InfinityDrive", "UnrelentingAssault", "Transform", "HeavensDemise"},
    Lightning = {"VoltageUp", "LightningPalm", "CrashingThunder", "ProjectedBurst", "CrushingJudgment", "Raigo"},
    Nika = {"RocGun", "NeoRedHawk", "RocGatling", "RedRoc", "DrumsOfLiberation", "Gear5", "SpinningTop", "DawnRocket", "MolePistolCombo", "RisingBolt", "GigantStamp", "BajrangGun"},
    DragonV2 = {"InfernoBreath", "ThunderBagua", "DragonTwister", "BeastsBellow", "Transform", "BoloFrenzy", "FlamingTorch", "Demolition", "Transformation"},
    Soul = {"EnthralGrasp", "ScorchingSickle", "ZeusMeadow", "CrimsonPillar", "Transform", "MaserCannon"},
    DarkXQuake = {"AntiQuake", "BlackHolePath", "BlackTurret", "NeoKurouzuCombo", "AntiBody", "QuadraSeaQuake"},
    Okuchi = {"PrimalRage", "ArcticBreath", "DevastatingDrop", "HallowedCuts", "GlacialCoat", "DivineSerpent"},
}

-- üß¨ C·∫≠p nh·∫≠t tr√°i hi·ªán t·∫°i
local function updateCurrentFruit()
    local mainData = player:FindFirstChild("MAIN_DATA")
    if not mainData then return end
    local currentSlot = mainData:FindFirstChild("Slot")
    if not currentSlot then return end
    local slotValue = mainData.Slots:FindFirstChild(tostring(currentSlot.Value))
    currentFruit = slotValue and slotValue.Value or nil
end

-- üëÄ Theo d√µi thay ƒë·ªïi slot tr√°i
local function watchSlotChanges()
    local mainData = player:WaitForChild("MAIN_DATA", 10)
    if not mainData then return end
    local slot = mainData:WaitForChild("Slot", 5)
    if not slot then return end
    slot:GetPropertyChangedSignal("Value"):Connect(updateCurrentFruit)
    updateCurrentFruit()
end

-- üß† G·ªçi k·ªπ nƒÉng tr√°i
local function castSkill(fruit, skill)
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    local origin, target = hrp.Position, mouse.Hit.Position
    local dir = (target - origin).Unit * 45
    local ray = {
        Normal = Vector3.yAxis,
        Direction = dir,
        Origin = origin,
        Instance = workspace.Map:FindFirstChildWhichIsA("BasePart") or workspace.Terrain,
        Distance = (target - origin).Magnitude,
        Material = Enum.Material.Grass,
        Position = target
    }

    ReplicatedStorage.Replicator:InvokeServer(fruit, skill, {Ground = {Position = target}, MouseRay = ray})
    ReplicatedStorage.ReplicatorNoYield:FireServer("ClientData", "UpdateData", {RootCF = hrp.CFrame, MouseRay = ray})
end

-- üîç T√¨m n√∫t Play
local function findPlayButton()
    for _, guiObj in ipairs(gui:GetChildren()) do
        if guiObj:IsA("ScreenGui") then
            local btn = guiObj:FindFirstChild("Play", true)
            if btn and btn:IsA("GuiButton") then
                return btn
            end
        end
    end
    return nil
end

-- ‚å®Ô∏è M√¥ ph·ªèng nh·∫•n Enter
local function pressEnter()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
end

-- üìç D·ªãch chuy·ªÉn nh√¢n v·∫≠t
local function fastTeleport()
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp
    repeat
        character = player.Character
        hrp = character and character:FindFirstChild("HumanoidRootPart")
        task.wait()
    until hrp
    hrp.CFrame = CFrame.new(-1420, 798.93, -85)
end

-- üß† Setup nh√¢n v·∫≠t
local function setupCharacter(character)
    currentHumanoid = character:WaitForChild("Humanoid")
    local success
    repeat
        success, staminaBar = pcall(function()
            return player:WaitForChild("PlayerGui"):WaitForChild("UI"):WaitForChild("HUD"):WaitForChild("Bars"):WaitForChild("Stamina")
        end)
        task.wait()
    until success and staminaBar
end

-- üëÇ Theo d√µi spawn nh√¢n v·∫≠t
player.CharacterAdded:Connect(setupCharacter)
if player.Character then setupCharacter(player.Character) end
task.spawn(watchSlotChanges)

-- ‚ñ∂Ô∏è Auto nh·∫•n Play v√† Teleport
task.spawn(function()
    while true do
        if not (player.Character and player.Character:FindFirstChild("HumanoidRootPart")) then
            repeat
                local playButton = findPlayButton()
                if playButton then
                    GuiService.SelectedObject = playButton
                    task.wait(0.2)
                    pressEnter()
                end
                task.wait(1)
            until player.Character and player.Character:FindFirstChild("HumanoidRootPart")

            _isInGame = true
            fastTeleport()
        end
        task.wait(2)
    end
end)

-- üîÅ T·ª± d√πng chi√™u
task.spawn(function()
    while true do
        if _G.auto and _isInGame and currentFruit and skills[currentFruit] and staminaBar then
            local manaPercent = staminaBar.Size.X.Scale
            if manaPercent > THRESHOLD then
                for _, skill in ipairs(skills[currentFruit]) do
                    castSkill(currentFruit, skill)
                    task.wait(0.15)
                    if staminaBar.Size.X.Scale <= THRESHOLD then
                        break
                    end
                end
            end
        end
        task.wait(0.3)
    end
end)

-- üß† Auto Reset khi mana th·∫•p
RunService.Heartbeat:Connect(function()
    if _G.auto and _isInGame and staminaBar and currentHumanoid then
        local percent = staminaBar.Size.X.Scale
        if percent <= THRESHOLD and currentHumanoid.Health > 0 then
            warn("‚ö†Ô∏è Mana th·∫•p! Reset nh√¢n v·∫≠t...")
            task.spawn(function()
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Escape, false, game)
                task.wait(0.2)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Escape, false, game)
                task.wait(0.2)
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.R, false, game)
                task.wait(0.2)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.R, false, game)
                task.wait(0.2)
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                task.wait(0.2)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
            end)
        end
    end
end)
